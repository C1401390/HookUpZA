<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Ad - HookUpZA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-black text-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top shadow-lg">
    <div class="container">
      <a class="navbar-brand fw-bold fs-3" href="index.html">
        <span class="text-danger">Hook</span><span class="text-white">UpZA</span>
      </a>
      <div class="d-flex gap-3">
        <a href="my-ads.html" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back to My Ads
        </a>
      </div>
    </div>
  </nav>

  <section class="py-5 mt-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          
          <div class="card bg-dark border-danger">
            <div class="card-header bg-transparent border-danger">
              <h4 class="mb-0"><i class="bi bi-pencil-square text-danger"></i> Edit Your Ad</h4>
            </div>
            <div class="card-body p-4">
              
              <div id="loadingIndicator" class="text-center py-5">
                <div class="spinner-border text-danger"></div>
                <p class="mt-3">Loading ad details...</p>
              </div>

              <form id="editAdForm" class="d-none">
                <input type="hidden" id="adId">
                
                <div class="mb-4">
                  <label class="form-label fw-bold">Title <span class="text-danger">*</span></label>
                  <input type="text" class="form-control bg-dark border-secondary text-light" 
                         id="title" required>
                </div>

                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Category <span class="text-danger">*</span></label>
                    <select class="form-select bg-dark border-secondary text-light" id="category" required>
                      <option value="">Select category</option>
                      <option value="mw4m">Men Looking for Women</option>
                      <option value="wf4m">Women Looking for Men</option>
                      <option value="mw4mw">Men Looking for Men</option>
                      <option value="wf4w">Women Looking for Women</option>
                      <option value="couples">Couples</option>
                      <option value="lgbtq">LGBTQ+</option>
                      <option value="hookups">Casual Hookups</option>
                      <option value="services">Services & Escorts</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Location</label>
                    <input type="text" class="form-control bg-dark border-secondary text-light" 
                           id="location" placeholder="e.g., Sea Point">
                  </div>
                </div>

                <div class="mb-4">
                  <label class="form-label fw-bold">Description <span class="text-danger">*</span></label>
                  <textarea class="form-control bg-dark border-secondary text-light" 
                            id="description" rows="6" required></textarea>
                </div>

                <div class="mb-4">
                  <label class="form-label fw-bold">Rate (Optional)</label>
                  <input type="text" class="form-control bg-dark border-secondary text-light" 
                         id="rate" placeholder="e.g., R500/hour">
                </div>

                <div class="mb-4">
                  <label class="form-label fw-bold">Contact <span class="text-danger">*</span></label>
                  <input type="text" class="form-control bg-dark border-secondary text-light" 
                         id="contact" placeholder="WhatsApp: 082 123 4567" required>
                </div>

                <div class="mb-4">
                  <label class="form-label fw-bold">Photos</label>
                  <div class="row g-3 mb-3" id="photoPreview"></div>
                  <div class="input-group">
                    <input type="file" class="form-control bg-dark border-secondary text-light" 
                           id="photoUpload" accept="image/*" multiple>
                    <button type="button" class="btn btn-outline-danger" onclick="uploadPhotos()">
                      <i class="bi bi-cloud-upload"></i> Upload
                    </button>
                  </div>
                  <small class="text-muted">Max 5 photos, 5MB each. Formats: jpg, png, gif, webp</small>
                </div>

                <div class="alert alert-info bg-transparent border-info">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Note:</strong> Changes will be saved immediately. Your ad will remain active.
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-danger btn-lg fw-bold" id="saveBtn">
                    <i class="bi bi-check-circle me-2"></i>Save Changes
                  </button>
                  <a href="my-ads.html" class="btn btn-outline-secondary">Cancel</a>
                </div>
              </form>

            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API = 'http://127.0.0.1:5000/api';
    let currentPhotos = [];
    let adId = null;

    // Get ad ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    adId = urlParams.get('id');

    if (!adId) {
      alert('No ad ID provided');
      window.location.href = 'my-ads.html';
    }

    // Load ad details
    async function loadAd() {
      try {
        const res = await fetch(`${API}/get_ad/${adId}`, {
          credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Failed to load ad');
        
        const data = await res.json();
        const ad = data.ad;
        
        // Populate form
        document.getElementById('adId').value = ad.id;
        document.getElementById('title').value = ad.title || '';
        document.getElementById('category').value = ad.category || '';
        document.getElementById('location').value = ad.location || '';
        document.getElementById('description').value = ad.description || '';
        document.getElementById('rate').value = ad.rate || '';
        document.getElementById('contact').value = ad.contact || '';
        
        // Load photos
        if (ad.photos) {
          currentPhotos = Array.isArray(ad.photos) ? ad.photos : JSON.parse(ad.photos || '[]');
          displayPhotos();
        }
        
        // Show form
        document.getElementById('loadingIndicator').classList.add('d-none');
        document.getElementById('editAdForm').classList.remove('d-none');
        
      } catch (error) {
        console.error('Error loading ad:', error);
        alert('Failed to load ad. You may not have permission to edit this ad.');
        window.location.href = 'my-ads.html';
      }
    }

    // Display photo previews
    function displayPhotos() {
      const container = document.getElementById('photoPreview');
      
      if (currentPhotos.length === 0) {
        container.innerHTML = '<p class="text-muted">No photos uploaded yet</p>';
        return;
      }
      
      container.innerHTML = currentPhotos.map((photo, index) => `
        <div class="col-md-3">
          <div class="position-relative">
            <img src="${photo}" class="img-fluid rounded" alt="Photo ${index + 1}">
            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                    onclick="removePhoto(${index})">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Upload photos
    async function uploadPhotos() {
      const input = document.getElementById('photoUpload');
      const files = input.files;
      
      if (files.length === 0) {
        alert('Please select photos to upload');
        return;
      }
      
      if (currentPhotos.length + files.length > 5) {
        alert('Maximum 5 photos allowed');
        return;
      }
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Check file size
        if (file.size > 5 * 1024 * 1024) {
          alert(`${file.name} is too large. Max 5MB per photo.`);
          continue;
        }
        
        // Upload
        const formData = new FormData();
        formData.append('photo', file);
        
        try {
          const res = await fetch(`${API}/upload_photo`, {
            method: 'POST',
            credentials: 'include',
            body: formData
          });
          
          if (!res.ok) throw new Error('Upload failed');
          
          const data = await res.json();
          currentPhotos.push(data.url);
          
        } catch (error) {
          console.error('Upload error:', error);
          alert(`Failed to upload ${file.name}`);
        }
      }
      
      displayPhotos();
      input.value = ''; // Clear input
    }

    // Remove photo
    function removePhoto(index) {
      if (confirm('Remove this photo?')) {
        const photoUrl = currentPhotos[index];
        
        // Delete from server
        const filename = photoUrl.split('/').pop();
        fetch(`${API}/delete_photo`, {
          method: 'DELETE',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });
        
        currentPhotos.splice(index, 1);
        displayPhotos();
      }
    }

    // Save changes
    document.getElementById('editAdForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
      
      const data = {
        title: document.getElementById('title').value,
        category: document.getElementById('category').value,
        location: document.getElementById('location').value,
        description: document.getElementById('description').value,
        rate: document.getElementById('rate').value,
        contact: document.getElementById('contact').value,
        photos: currentPhotos
      };
      
      try {
        const res = await fetch(`${API}/edit_ad/${adId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (!res.ok) throw new Error('Save failed');
        
        alert('✅ Ad updated successfully!');
        window.location.href = 'my-ads.html';
        
      } catch (error) {
        console.error('Save error:', error);
        alert('❌ Failed to save changes. Please try again.');
        
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Save Changes';
      }
    });

    // Load ad on page load
    loadAd();
  </script>
</body>
</html>
