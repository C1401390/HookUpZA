<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - HookUpZA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background: #0a0a0a; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .ad-card { background: #1a1a1a; border: 1px solid #333; }
    .ad-card:hover { border-color: #dc3545; }
  </style>
</head>
<body class="text-light">

  <nav class="navbar navbar-dark bg-black border-bottom border-danger">
    <div class="container-fluid">
      <span class="navbar-brand">
        <i class="bi bi-shield-lock-fill text-danger"></i> Admin Dashboard
      </span>
      <div class="d-flex gap-2">
        <a href="admin-users.html" class="btn btn-outline-warning btn-sm">
          <i class="bi bi-people"></i> Users
        </a>
        <a href="index.html" class="btn btn-outline-light btn-sm">
          <i class="bi bi-house"></i> Back to Site
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    
    <!-- Stats Row -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="totalAds">0</h2>
          <p class="mb-0">Total Ads</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="pendingAds">0</h2>
          <p class="mb-0">Pending Review</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="activeAds">0</h2>
          <p class="mb-0">Active Ads</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="totalUsers">0</h2>
          <p class="mb-0">Total Users</p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <button class="btn btn-success w-100" onclick="runAutoApproval()">
          <i class="bi bi-check-circle"></i> Run Auto-Approval (24h+ ads)
        </button>
      </div>
      <div class="col-md-6">
        <button class="btn btn-warning w-100" onclick="expireOldAds()">
          <i class="bi bi-clock-history"></i> Expire Old Ads
        </button>
      </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-pills mb-3">
      <li class="nav-item">
        <button class="nav-link active" onclick="filterAds('all')">All</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" onclick="filterAds('pending')">Pending</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" onclick="filterAds('active')">Active</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" onclick="filterAds('expired')">Expired</button>
      </li>
    </ul>

    <!-- Ads List -->
    <div id="adsContainer">
      <div class="text-center py-5">
        <div class="spinner-border text-danger"></div>
        <p class="mt-3">Loading ads...</p>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allAds = [];
    const API = `${API_BASE}/api`;

    // CRITICAL: Check admin access
    async function checkAdmin() {
      try {
        const res = await fetch(`${API}/admin/check_role`, { 
          credentials: 'include'  // CRITICAL!
        });
        const data = await res.json();
        
        if (!data.is_admin) {
          alert('‚ùå Admin access required');
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Admin check failed:', error);
        alert('‚ùå Failed to verify admin status');
        window.location.href = 'index.html';
      }
    }

    // Load stats
    async function loadStats() {
      try {
        const res = await fetch(`${API}/admin/stats`, { 
          credentials: 'include'  // CRITICAL!
        });
        const stats = await res.json();
        
        document.getElementById('totalAds').textContent = stats.total_ads;
        document.getElementById('pendingAds').textContent = stats.pending_ads;
        document.getElementById('activeAds').textContent = stats.active_ads;
        document.getElementById('totalUsers').textContent = stats.total_users;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load all ads
    async function loadAds() {
      try {
        const res = await fetch(`${API}/admin/all_ads`, { 
          credentials: 'include'  // CRITICAL!
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        allAds = data.ads;
        displayAds(allAds);
        loadStats();
      } catch (error) {
        console.error('Error loading ads:', error);
        document.getElementById('adsContainer').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Failed to load ads. Make sure you're logged in as admin.
            <br><small>Error: ${error.message}</small>
          </div>
        `;
      }
    }

    // Display ads
    function displayAds(ads) {
      const container = document.getElementById('adsContainer');
      
      if (ads.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No ads found</p>';
        return;
      }
      
      container.innerHTML = ads.map(ad => {
        const daysLeft = calculateDaysLeft(ad.expires_at);
        const statusColor = {
          'pending': 'warning',
          'active': 'success',
          'expired': 'secondary',
          'rejected': 'danger'
        }[ad.status] || 'secondary';
        
        return `
          <div class="ad-card p-3 rounded mb-3">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h5>${ad.title}</h5>
                <p class="small mb-2">${ad.description.substring(0, 100)}...</p>
                <div class="d-flex gap-2 flex-wrap">
                  <span class="badge bg-${statusColor}">${ad.status.toUpperCase()}</span>
                  <span class="badge bg-secondary">${ad.category}</span>
                  <span class="badge bg-info">${ad.account_type === 'vendor' ? 'PREMIUM' : 'FREE'}</span>
                  ${daysLeft >= 0 ? `<span class="badge bg-dark">${daysLeft} days left</span>` : '<span class="badge bg-danger">EXPIRED</span>'}
                </div>
              </div>
              <div class="col-md-3">
                <p class="small mb-1"><strong>User:</strong> ${ad.username}</p>
                <p class="small mb-1"><strong>Posted:</strong> ${formatDate(ad.created_at)}</p>
                <p class="small mb-0"><strong>Location:</strong> ${ad.location}</p>
              </div>
              <div class="col-md-3 text-end">
                ${ad.status === 'pending' ? `
                  <button class="btn btn-sm btn-success mb-2 w-100" onclick="approveAd(${ad.id})">
                    ‚úÖ Approve
                  </button>
                  <button class="btn btn-sm btn-danger w-100" onclick="rejectAd(${ad.id})">
                    ‚ùå Reject
                  </button>
                ` : ''}
                ${ad.status === 'active' ? `
                  <button class="btn btn-sm btn-warning w-100" onclick="expireAd(${ad.id})">
                    üïí Expire Now
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Filter ads
    function filterAds(status) {
      // Update active tab
      document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      if (status === 'all') {
        displayAds(allAds);
      } else {
        displayAds(allAds.filter(ad => ad.status === status));
      }
    }

    // Approve ad
    async function approveAd(id) {
      await fetch(`${API}/admin/approve_ad/${id}`, { 
        method: 'POST',
        credentials: 'include'  // CRITICAL!
      });
      alert('‚úÖ Ad approved!');
      loadAds();
    }

    // Reject ad
    async function rejectAd(id) {
      await fetch(`${API}/admin/reject_ad/${id}`, { 
        method: 'POST',
        credentials: 'include'  // CRITICAL!
      });
      alert('‚ùå Ad rejected!');
      loadAds();
    }

    // Expire ad manually
    async function expireAd(id) {
      await fetch(`${API}/admin/reject_ad/${id}`, { 
        method: 'POST',
        credentials: 'include'  // CRITICAL!
      });
      alert('üïí Ad expired!');
      loadAds();
    }

    // Run auto-approval
    async function runAutoApproval() {
      const res = await fetch(`${API}/admin/auto_approve`, { 
        method: 'POST',
        credentials: 'include'  // CRITICAL!
      });
      const data = await res.json();
      alert(`‚úÖ ${data.count} ads auto-approved!`);
      loadAds();
    }

    // Expire old ads
    async function expireOldAds() {
      const res = await fetch(`${API}/admin/expire_old_ads`, { 
        method: 'POST',
        credentials: 'include'  // CRITICAL!
      });
      const data = await res.json();
      alert(`üïí ${data.count} ads expired!`);
      loadAds();
    }

    // Helpers
    function calculateDaysLeft(expiresAt) {
      const now = new Date();
      const expires = new Date(expiresAt);
      const diff = expires - now;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString();
    }

    // Load on page load
    checkAdmin();
    loadAds();
    
    // Refresh every 30 seconds
    setInterval(loadStats, 30000);
  </script>
</body>
</html>
