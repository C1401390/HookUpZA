<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - HookUpZA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background: #0a0a0a; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; text-align: center; color: #fff; }
    .ad-row { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .ad-row:hover { border-color: #dc3545; }
  </style>
</head>
<body class="text-light">

  <nav class="navbar navbar-dark bg-black border-bottom border-danger">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">
        <i class="bi bi-shield-lock-fill text-danger me-2"></i>Admin Dashboard
      </span>
      <div class="d-flex gap-2">
        <a href="admin-users.html" class="btn btn-outline-warning btn-sm">
          <i class="bi bi-people me-1"></i>Users
        </a>
        <a href="index.html" class="btn btn-outline-light btn-sm">
          <i class="bi bi-house me-1"></i>Site
        </a>
      </div>
    </div>
  </nav>

  <!-- Status bar -->
  <div id="statusBar" style="display:none" class="alert rounded-0 mb-0 py-2 text-center fw-bold"></div>

  <div class="container-fluid py-4">

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3"><div class="stat-card"><h2 id="sTotalAds">â€”</h2><div>Total Ads</div></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h2 id="sPending">â€”</h2><div>Pending</div></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h2 id="sActive">â€”</h2><div>Active</div></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h2 id="sUsers">â€”</h2><div>Total Users</div></div></div>
    </div>

    <!-- Bulk actions -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <button class="btn btn-success w-100" onclick="bulkAutoApprove()">
          <i class="bi bi-check-all me-1"></i>Auto-Approve (24h+ pending ads)
        </button>
      </div>
      <div class="col-md-6">
        <button class="btn btn-warning w-100" onclick="bulkExpire()">
          <i class="bi bi-clock-history me-1"></i>Expire Old Ads
        </button>
      </div>
    </div>

    <!-- Filter tabs -->
    <div class="d-flex gap-2 mb-3 flex-wrap" id="tabs">
      <button class="btn btn-sm btn-danger"    onclick="setFilter('all',this)">All</button>
      <button class="btn btn-sm btn-outline-warning" onclick="setFilter('pending',this)">Pending</button>
      <button class="btn btn-sm btn-outline-success" onclick="setFilter('active',this)">Active</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="setFilter('expired',this)">Expired</button>
      <button class="btn btn-sm btn-outline-danger"   onclick="setFilter('rejected',this)">Rejected</button>
    </div>

    <!-- Ads -->
    <div id="adsList">
      <div class="text-center py-5">
        <div class="spinner-border text-danger"></div>
        <p class="mt-2 text-muted">Loading ads...</p>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/hookupza.js"></script>
  <script>

    // â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function h(s) {
      return String(s == null ? '' : s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function showMsg(msg, type) {
      var el = document.getElementById('statusBar');
      el.className = 'alert alert-' + type + ' rounded-0 mb-0 py-2 text-center fw-bold';
      el.textContent = msg;
      el.style.display = 'block';
      if (type === 'success') setTimeout(function(){ el.style.display='none'; }, 3000);
    }
    function api(path, opts) {
      return fetch(API_BASE + path, Object.assign({ credentials:'include' }, opts || {}));
    }

    // â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var ALL_ADS = [];
    var currentFilter = 'all';

    // â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      console.log('Admin init, API_BASE =', JSON.stringify(API_BASE));

      // Verify admin
      var r = await api('/api/admin/check_role');
      var d = await r.json();
      console.log('Admin check:', d);
      if (!d.is_admin) {
        alert('âŒ Admin access required');
        window.location.href = 'index.html';
        return;
      }

      await loadAll();
      setInterval(loadStats, 30000);
    }

    async function loadAll() {
      await loadStats();
      await loadAds();
    }

    async function loadStats() {
      try {
        var r = await api('/api/admin/stats');
        if (!r.ok) return;
        var s = await r.json();
        document.getElementById('sTotalAds').textContent = s.total_ads   ?? '?';
        document.getElementById('sPending').textContent  = s.pending_ads ?? '?';
        document.getElementById('sActive').textContent   = s.active_ads  ?? '?';
        document.getElementById('sUsers').textContent    = s.total_users  ?? '?';
      } catch(e) { console.warn('Stats error', e); }
    }

    async function loadAds() {
      document.getElementById('adsList').innerHTML =
        '<div class="text-center py-4"><div class="spinner-border text-danger"></div></div>';
      try {
        var r = await api('/api/admin/all_ads');
        console.log('all_ads status:', r.status);
        if (!r.ok) {
          var txt = await r.text();
          throw new Error('HTTP ' + r.status + ': ' + txt);
        }
        var data = await r.json();
        ALL_ADS = data.ads || [];
        console.log('Got', ALL_ADS.length, 'ads from API');
        renderAds();
      } catch(e) {
        console.error('loadAds error:', e);
        document.getElementById('adsList').innerHTML =
          '<div class="alert alert-danger">âŒ ' + h(e.message) + '</div>';
        showMsg('âŒ Failed to load ads: ' + e.message, 'danger');
      }
    }

    function setFilter(f, btn) {
      currentFilter = f;
      document.querySelectorAll('#tabs button').forEach(function(b){
        b.className = b.className.replace('btn-danger','btn-outline-secondary')
                                 .replace(/btn-(?!outline)\w+/,'btn-outline-secondary');
      });
      if (btn) btn.className = btn.className.replace('btn-outline-','btn-').replace('btn-outline-secondary','btn-secondary');
      renderAds();
    }

    function renderAds() {
      var ads = currentFilter === 'all'
        ? ALL_ADS
        : ALL_ADS.filter(function(a){ return a.status === currentFilter; });

      console.log('Rendering', ads.length, 'ads (filter:', currentFilter + ')');
      var el = document.getElementById('adsList');

      if (ads.length === 0) {
        el.innerHTML = '<div class="text-center py-5 text-muted">' +
          '<i class="bi bi-inbox display-3 d-block mb-3"></i>' +
          'No ' + currentFilter + ' ads found</div>';
        return;
      }

      var rows = ads.map(buildRow).join('');
      el.innerHTML = rows;
      console.log('âœ… Rendered', ads.length, 'rows into #adsList, innerHTML length:', el.innerHTML.length);
    }

    function buildRow(ad) {
      var daysLeft = ad.expires_at
        ? Math.floor((new Date(ad.expires_at) - Date.now()) / 86400000)
        : -1;

      var sc = { active:'success', pending:'warning', expired:'secondary', rejected:'danger' }[ad.status] || 'secondary';
      var desc = h((ad.description || '').substring(0,120));

      // Build action buttons
      var btns = '';
      if (ad.status === 'pending') {
        btns += '<button class="btn btn-sm btn-success mb-1 w-100" onclick="approve(' + ad.id + ')">' +
                  '<i class="bi bi-check-circle me-1"></i>Approve</button>';
        btns += '<button class="btn btn-sm btn-danger mb-1 w-100" onclick="reject(' + ad.id + ')">' +
                  '<i class="bi bi-x-circle me-1"></i>Reject</button>';
      }
      if (ad.status === 'active') {
        btns += '<button class="btn btn-sm btn-warning mb-1 w-100" onclick="expire(' + ad.id + ')">' +
                  '<i class="bi bi-clock me-1"></i>Expire Now</button>';
      }
      if (ad.status === 'rejected' || ad.status === 'expired') {
        btns += '<button class="btn btn-sm btn-outline-success mb-1 w-100" onclick="approve(' + ad.id + ')">' +
                  '<i class="bi bi-arrow-counterclockwise me-1"></i>Reactivate</button>';
      }
      btns += '<button class="btn btn-sm btn-outline-danger w-100" onclick="del(' + ad.id + ')">' +
                '<i class="bi bi-trash me-1"></i>Delete</button>';

      return (
        '<div class="ad-row">' +
          '<div class="row">' +
            '<div class="col-md-6 mb-2">' +
              '<div class="fw-bold mb-1">' + h(ad.title || 'Untitled') + '</div>' +
              '<div class="text-muted small mb-2">' + desc + (desc.length >= 120 ? 'â€¦' : '') + '</div>' +
              '<div class="d-flex flex-wrap gap-1">' +
                '<span class="badge bg-' + sc + '">' + h(ad.status || '').toUpperCase() + '</span>' +
                '<span class="badge bg-secondary">' + h(ad.category || '') + '</span>' +
                '<span class="badge ' + (ad.account_type==='vendor'?'bg-warning text-dark':'bg-info text-dark') + '">' +
                  (ad.account_type==='vendor'?'PREMIUM':'FREE') + '</span>' +
                (daysLeft >= 0
                  ? '<span class="badge bg-dark">' + daysLeft + 'd left</span>'
                  : '<span class="badge bg-danger">EXPIRED</span>') +
              '</div>' +
            '</div>' +
            '<div class="col-md-3 small text-muted mb-2">' +
              '<div><i class="bi bi-person me-1"></i>' + h(ad.username || '?') + '</div>' +
              '<div><i class="bi bi-geo-alt me-1"></i>' + h(ad.location || '-') + '</div>' +
              '<div><i class="bi bi-calendar me-1"></i>' +
                (ad.created_at ? new Date(ad.created_at).toLocaleDateString() : '-') + '</div>' +
              '<div class="text-muted">ID #' + ad.id + '</div>' +
            '</div>' +
            '<div class="col-md-3">' + btns + '</div>' +
          '</div>' +
        '</div>'
      );
    }

    // â”€â”€ actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function approve(id) {
      showMsg('Approving...', 'info');
      var r = await api('/api/admin/approve_ad/' + id, { method:'POST' });
      if (r.ok) { showMsg('âœ… Approved!', 'success'); loadAll(); }
      else showMsg('âŒ Failed', 'danger');
    }
    async function reject(id) {
      var r = await api('/api/admin/reject_ad/' + id, { method:'POST' });
      if (r.ok) { showMsg('Rejected', 'warning'); loadAll(); }
    }
    async function expire(id) {
      var r = await api('/api/admin/reject_ad/' + id, { method:'POST' });
      if (r.ok) { showMsg('Expired', 'warning'); loadAll(); }
    }
    async function del(id) {
      if (!confirm('Permanently delete this ad?')) return;
      showMsg('Deleting...', 'info');
      var r = await api('/api/admin/delete_ad/' + id, { method:'DELETE' });
      if (r.ok) { showMsg('âœ… Deleted', 'success'); loadAll(); }
      else showMsg('âŒ Failed to delete', 'danger');
    }
    async function bulkAutoApprove() {
      showMsg('Running auto-approval...', 'info');
      var r = await api('/api/admin/auto_approve', { method:'POST' });
      var d = await r.json().catch(function(){ return {}; });
      showMsg('âœ… ' + (d.count||0) + ' ads approved', 'success');
      loadAll();
    }
    async function bulkExpire() {
      showMsg('Expiring old ads...', 'info');
      var r = await api('/api/admin/expire_old_ads', { method:'POST' });
      var d = await r.json().catch(function(){ return {}; });
      showMsg('ğŸ•’ ' + (d.count||0) + ' ads expired', 'warning');
      loadAll();
    }

    // â”€â”€ boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    init();
  </script>
</body>
</html>
