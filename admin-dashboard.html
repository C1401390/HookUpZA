<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - HookUpZA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background: #0a0a0a; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .ad-card { background: #1a1a1a; border: 1px solid #333; }
    .ad-card:hover { border-color: #dc3545; }
  </style>
</head>
<body class="text-light">

  <nav class="navbar navbar-dark bg-black border-bottom border-danger">
    <div class="container-fluid">
      <span class="navbar-brand">
        <i class="bi bi-shield-lock-fill text-danger"></i> Admin Dashboard
      </span>
      <div class="d-flex gap-2">
        <a href="admin-users.html" class="btn btn-outline-warning btn-sm">
          <i class="bi bi-people"></i> Users
        </a>
        <a href="index.html" class="btn btn-outline-light btn-sm">
          <i class="bi bi-house"></i> Back to Site
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="totalAds">-</h2><p class="mb-0">Total Ads</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="pendingAds">-</h2><p class="mb-0">Pending Review</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="activeAds">-</h2><p class="mb-0">Active Ads</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card p-4 rounded text-center text-white">
          <h2 id="totalUsers">-</h2><p class="mb-0">Total Users</p>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <button class="btn btn-success w-100" onclick="runAutoApproval()">
          <i class="bi bi-check-circle"></i> Run Auto-Approval (24h+ ads)
        </button>
      </div>
      <div class="col-md-6">
        <button class="btn btn-warning w-100" onclick="expireOldAds()">
          <i class="bi bi-clock-history"></i> Expire Old Ads
        </button>
      </div>
    </div>

    <ul class="nav nav-pills mb-3" id="filterTabs">
      <li class="nav-item"><button class="nav-link active" onclick="filterAds('all',this)">All</button></li>
      <li class="nav-item"><button class="nav-link" onclick="filterAds('pending',this)">Pending</button></li>
      <li class="nav-item"><button class="nav-link" onclick="filterAds('active',this)">Active</button></li>
      <li class="nav-item"><button class="nav-link" onclick="filterAds('expired',this)">Expired</button></li>
    </ul>

    <div id="adsContainer">
      <div class="text-center py-5">
        <div class="spinner-border text-danger"></div>
        <p class="mt-3">Loading ads...</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/hookupza.js"></script>
  <script>
    var allAds = [];

    async function checkAdmin() {
      try {
        var res = await fetch(API_BASE + '/api/admin/check_role', { credentials: 'include' });
        var data = await res.json();
        if (!data.is_admin) { alert('‚ùå Admin access required'); window.location.href = 'index.html'; }
      } catch(e) { alert('‚ùå Cannot verify admin status'); window.location.href = 'index.html'; }
    }

    async function loadStats() {
      try {
        var res = await fetch(API_BASE + '/api/admin/stats', { credentials: 'include' });
        var s = await res.json();
        document.getElementById('totalAds').textContent   = s.total_ads   || 0;
        document.getElementById('pendingAds').textContent = s.pending_ads || 0;
        document.getElementById('activeAds').textContent  = s.active_ads  || 0;
        document.getElementById('totalUsers').textContent = s.total_users  || 0;
      } catch(e) { console.error('Stats error:', e); }
    }

    async function loadAds() {
      try {
        var res = await fetch(API_BASE + '/api/admin/all_ads', { credentials: 'include' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        var data = await res.json();
        allAds = data.ads || [];
        displayAds(allAds);
        loadStats();
      } catch(e) {
        document.getElementById('adsContainer').innerHTML =
          '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Failed to load ads: ' + e.message + '</div>';
      }
    }

    function displayAds(ads) {
      var c = document.getElementById('adsContainer');
      if (!ads || !ads.length) { c.innerHTML = '<p class="text-center text-muted py-4">No ads found</p>'; return; }
      var colors = { pending:'warning', active:'success', expired:'secondary', rejected:'danger' };
      c.innerHTML = ads.map(function(ad) {
        var daysLeft = Math.floor((new Date(ad.expires_at) - new Date()) / 86400000);
        var sc = colors[ad.status] || 'secondary';
        var desc = (ad.description || '').substring(0, 100);
        return '<div class="ad-card p-3 rounded mb-3">' +
          '<div class="row align-items-center">' +
          '<div class="col-md-6">' +
            '<h5>' + (ad.title||'Untitled') + '</h5>' +
            '<p class="small mb-2">' + desc + (desc.length>=100?'...':'') + '</p>' +
            '<div class="d-flex gap-2 flex-wrap">' +
              '<span class="badge bg-' + sc + '">' + (ad.status||'').toUpperCase() + '</span>' +
              '<span class="badge bg-secondary">' + (ad.category||'') + '</span>' +
              '<span class="badge bg-info">' + (ad.account_type==='vendor'?'PREMIUM':'FREE') + '</span>' +
              (daysLeft>=0 ? '<span class="badge bg-dark">' + daysLeft + 'd left</span>' : '<span class="badge bg-danger">EXPIRED</span>') +
            '</div>' +
          '</div>' +
          '<div class="col-md-3">' +
            '<p class="small mb-1"><strong>User:</strong> ' + (ad.username||'') + '</p>' +
            '<p class="small mb-1"><strong>Posted:</strong> ' + (ad.created_at ? new Date(ad.created_at).toLocaleDateString() : '-') + '</p>' +
            '<p class="small mb-0"><strong>Location:</strong> ' + (ad.location||'') + '</p>' +
          '</div>' +
          '<div class="col-md-3 text-end">' +
            (ad.status==='pending' ?
              '<button class="btn btn-sm btn-success mb-2 w-100" onclick="approveAd(' + ad.id + ')">‚úÖ Approve</button>' +
              '<button class="btn btn-sm btn-danger w-100" onclick="rejectAd(' + ad.id + ')">‚ùå Reject</button>' : '') +
            (ad.status==='active' ?
              '<button class="btn btn-sm btn-warning w-100" onclick="expireAd(' + ad.id + ')">üïí Expire Now</button>' : '') +
          '</div>' +
          '</div></div>';
      }).join('');
    }

    function filterAds(status, btn) {
      document.querySelectorAll('#filterTabs .nav-link').forEach(function(b){ b.classList.remove('active'); });
      if (btn) btn.classList.add('active');
      displayAds(status === 'all' ? allAds : allAds.filter(function(a){ return a.status === status; }));
    }

    async function approveAd(id) {
      await fetch(API_BASE + '/api/admin/approve_ad/' + id, { method:'POST', credentials:'include' });
      loadAds();
    }
    async function rejectAd(id) {
      await fetch(API_BASE + '/api/admin/reject_ad/' + id, { method:'POST', credentials:'include' });
      loadAds();
    }
    async function expireAd(id) {
      await fetch(API_BASE + '/api/admin/reject_ad/' + id, { method:'POST', credentials:'include' });
      loadAds();
    }
    async function runAutoApproval() {
      var res = await fetch(API_BASE + '/api/admin/auto_approve', { method:'POST', credentials:'include' });
      var d = await res.json();
      alert('‚úÖ ' + (d.count||0) + ' ads auto-approved!');
      loadAds();
    }
    async function expireOldAds() {
      var res = await fetch(API_BASE + '/api/admin/expire_old_ads', { method:'POST', credentials:'include' });
      var d = await res.json();
      alert('üïí ' + (d.count||0) + ' ads expired!');
      loadAds();
    }

    checkAdmin();
    loadAds();
    setInterval(loadStats, 30000);
  </script>
</body>
</html>
