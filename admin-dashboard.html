<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - HookUpZA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background: #0a0a0a; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; }
    .ad-row { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; transition: border-color .2s; }
    .ad-row:hover { border-color: #dc3545; }
  </style>
</head>
<body class="text-light">

  <nav class="navbar navbar-dark bg-black border-bottom border-danger">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">
        <i class="bi bi-shield-lock-fill text-danger"></i> Admin Dashboard
      </span>
      <div class="d-flex gap-2">
        <a href="admin-users.html" class="btn btn-outline-warning btn-sm">
          <i class="bi bi-people"></i> Users
        </a>
        <a href="index.html" class="btn btn-outline-light btn-sm">
          <i class="bi bi-house"></i> Back to Site
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="stat-card p-4 text-center text-white">
          <h2 class="mb-0" id="totalAds">‚Äî</h2><p class="mb-0 small">Total Ads</p>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card p-4 text-center text-white">
          <h2 class="mb-0" id="pendingAds">‚Äî</h2><p class="mb-0 small">Pending</p>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card p-4 text-center text-white">
          <h2 class="mb-0" id="activeAds">‚Äî</h2><p class="mb-0 small">Active</p>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card p-4 text-center text-white">
          <h2 class="mb-0" id="totalUsers">‚Äî</h2><p class="mb-0 small">Total Users</p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <button class="btn btn-success w-100" onclick="runAutoApproval()">
          <i class="bi bi-check-circle"></i> Run Auto-Approval (24h+ ads)
        </button>
      </div>
      <div class="col-md-6">
        <button class="btn btn-warning w-100" onclick="expireOldAds()">
          <i class="bi bi-clock-history"></i> Expire Old Ads
        </button>
      </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-pills mb-3" id="filterTabs">
      <li class="nav-item"><button class="nav-link active" onclick="filterAds('all',this)">All</button></li>
      <li class="nav-item"><button class="nav-link" onclick="filterAds('pending',this)">Pending</button></li>
      <li class="nav-item"><button class="nav-link" onclick="filterAds('active',this)">Active</button></li>
      <li class="nav-item"><button class="nav-link" onclick="filterAds('expired',this)">Expired</button></li>
    </ul>

    <!-- Status message -->
    <div id="statusMsg" style="display:none" class="alert alert-info py-2 mb-3"></div>

    <!-- Ads container -->
    <div id="adsContainer">
      <div class="text-center py-5">
        <div class="spinner-border text-danger"></div>
        <p class="mt-3 text-muted">Loading ads...</p>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/hookupza.js"></script>
  <script>
    var allAds = [];

    async function init() {
      // Verify admin
      try {
        var r = await fetch(API_BASE + '/api/admin/check_role', { credentials: 'include' });
        var d = await r.json();
        if (!d.is_admin) { alert('‚ùå Admin access required'); window.location.href = 'index.html'; return; }
      } catch(e) { alert('‚ùå Cannot verify admin'); window.location.href = 'index.html'; return; }

      // Load ads and stats together
      await loadAds();
      loadStats();
      setInterval(loadStats, 30000);
    }

    async function loadStats() {
      try {
        var r = await fetch(API_BASE + '/api/admin/stats', { credentials: 'include' });
        if (!r.ok) return;
        var s = await r.json();
        document.getElementById('totalAds').textContent   = s.total_ads   !== undefined ? s.total_ads   : '?';
        document.getElementById('pendingAds').textContent = s.pending_ads !== undefined ? s.pending_ads : '?';
        document.getElementById('activeAds').textContent  = s.active_ads  !== undefined ? s.active_ads  : '?';
        document.getElementById('totalUsers').textContent = s.total_users  !== undefined ? s.total_users  : '?';
      } catch(e) { console.error('Stats error:', e); }
    }

    async function loadAds() {
      showStatus('Loading ads...', 'info');
      try {
        var r = await fetch(API_BASE + '/api/admin/all_ads', { credentials: 'include' });
        if (!r.ok) {
          var errText = await r.text();
          throw new Error('HTTP ' + r.status + ': ' + errText);
        }
        var data = await r.json();
        allAds = data.ads || [];
        console.log('‚úÖ Admin loaded', allAds.length, 'ads');
        hideStatus();
        displayAds(allAds);
      } catch(e) {
        console.error('loadAds error:', e);
        showStatus('‚ùå Failed to load ads: ' + e.message, 'danger');
        document.getElementById('adsContainer').innerHTML =
          '<div class="alert alert-danger">Failed to load ads: ' + e.message + '</div>';
      }
    }

    function displayAds(ads) {
      var c = document.getElementById('adsContainer');
      if (!ads || ads.length === 0) {
        c.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox display-3"></i><p class="mt-3">No ads found</p></div>';
        return;
      }
      var html = '';
      for (var i = 0; i < ads.length; i++) {
        var ad = ads[i];
        var daysLeft = ad.expires_at ? Math.floor((new Date(ad.expires_at) - new Date()) / 86400000) : -1;
        var statusColors = { pending:'warning', active:'success', expired:'secondary', rejected:'danger' };
        var sc = statusColors[ad.status] || 'secondary';
        var desc = ((ad.description || '') + '').substring(0, 120);

        html += '<div class="ad-row p-3 mb-3">';
        html += '<div class="row align-items-start">';

        // Left: title + description + badges
        html += '<div class="col-md-5 mb-2 mb-md-0">';
        html += '<h6 class="mb-1 text-white">' + escHtml(ad.title || 'Untitled') + '</h6>';
        html += '<p class="small text-muted mb-2">' + escHtml(desc) + (desc.length >= 120 ? '...' : '') + '</p>';
        html += '<div class="d-flex flex-wrap gap-1">';
        html += '<span class="badge bg-' + sc + '">' + (ad.status || '').toUpperCase() + '</span>';
        html += '<span class="badge bg-secondary">' + escHtml(ad.category || '') + '</span>';
        html += '<span class="badge ' + (ad.account_type === 'vendor' ? 'bg-warning text-dark' : 'bg-info text-dark') + '">' + (ad.account_type === 'vendor' ? 'PREMIUM' : 'FREE') + '</span>';
        if (daysLeft >= 0) {
          html += '<span class="badge bg-dark">' + daysLeft + 'd left</span>';
        } else {
          html += '<span class="badge bg-danger">EXPIRED</span>';
        }
        html += '</div></div>';

        // Middle: details
        html += '<div class="col-md-4 mb-2 mb-md-0">';
        html += '<p class="small mb-1"><i class="bi bi-person me-1 text-muted"></i>' + escHtml(ad.username || '?') + '</p>';
        html += '<p class="small mb-1"><i class="bi bi-geo-alt me-1 text-muted"></i>' + escHtml(ad.location || '-') + '</p>';
        html += '<p class="small mb-1"><i class="bi bi-calendar me-1 text-muted"></i>' + (ad.created_at ? new Date(ad.created_at).toLocaleDateString() : '-') + '</p>';
        html += '<p class="small mb-0"><i class="bi bi-hash me-1 text-muted"></i>ID: ' + ad.id + '</p>';
        html += '</div>';

        // Right: action buttons
        html += '<div class="col-md-3 d-flex flex-column gap-2">';
        if (ad.status === 'pending') {
          html += '<button class="btn btn-sm btn-success" onclick="approveAd(' + ad.id + ')"><i class="bi bi-check-circle me-1"></i>Approve</button>';
          html += '<button class="btn btn-sm btn-danger" onclick="rejectAd(' + ad.id + ')"><i class="bi bi-x-circle me-1"></i>Reject</button>';
        }
        if (ad.status === 'active') {
          html += '<button class="btn btn-sm btn-warning" onclick="expireAd(' + ad.id + ')"><i class="bi bi-clock me-1"></i>Expire Now</button>';
        }
        if (ad.status === 'rejected' || ad.status === 'expired') {
          html += '<button class="btn btn-sm btn-outline-success" onclick="approveAd(' + ad.id + ')"><i class="bi bi-arrow-counterclockwise me-1"></i>Reactivate</button>';
        }
        html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteAd(' + ad.id + ')"><i class="bi bi-trash me-1"></i>Delete</button>';
        html += '</div>';

        html += '</div></div>';
      }
      c.innerHTML = html;
    }

    function filterAds(status, btn) {
      document.querySelectorAll('#filterTabs .nav-link').forEach(function(b){ b.classList.remove('active'); });
      if (btn) btn.classList.add('active');
      displayAds(status === 'all' ? allAds : allAds.filter(function(a){ return a.status === status; }));
    }

    async function approveAd(id) {
      try {
        var r = await fetch(API_BASE + '/api/admin/approve_ad/' + id, { method: 'POST', credentials: 'include' });
        if (r.ok) { showStatus('‚úÖ Ad approved!', 'success'); await loadAds(); loadStats(); }
        else showStatus('‚ùå Failed to approve ad', 'danger');
      } catch(e) { showStatus('‚ùå Error: ' + e.message, 'danger'); }
    }
    async function rejectAd(id) {
      try {
        var r = await fetch(API_BASE + '/api/admin/reject_ad/' + id, { method: 'POST', credentials: 'include' });
        if (r.ok) { showStatus('Ad rejected', 'warning'); await loadAds(); loadStats(); }
        else showStatus('‚ùå Failed', 'danger');
      } catch(e) { showStatus('‚ùå ' + e.message, 'danger'); }
    }
    async function expireAd(id) {
      try {
        var r = await fetch(API_BASE + '/api/admin/reject_ad/' + id, { method: 'POST', credentials: 'include' });
        if (r.ok) { showStatus('Ad expired', 'warning'); await loadAds(); loadStats(); }
      } catch(e) {}
    }
    async function deleteAd(id) {
      if (!confirm('Delete this ad permanently?')) return;
      try {
        var r = await fetch(API_BASE + '/api/admin/delete_ad/' + id, { method: 'DELETE', credentials: 'include' });
        if (r.ok) { showStatus('‚úÖ Ad deleted', 'success'); await loadAds(); loadStats(); }
        else showStatus('‚ùå Failed to delete', 'danger');
      } catch(e) { showStatus('‚ùå ' + e.message, 'danger'); }
    }
    async function runAutoApproval() {
      try {
        var r = await fetch(API_BASE + '/api/admin/auto_approve', { method: 'POST', credentials: 'include' });
        var d = await r.json();
        showStatus('‚úÖ ' + (d.count||0) + ' ads auto-approved!', 'success');
        await loadAds(); loadStats();
      } catch(e) { showStatus('‚ùå ' + e.message, 'danger'); }
    }
    async function expireOldAds() {
      try {
        var r = await fetch(API_BASE + '/api/admin/expire_old_ads', { method: 'POST', credentials: 'include' });
        var d = await r.json();
        showStatus('üïí ' + (d.count||0) + ' ads expired', 'warning');
        await loadAds(); loadStats();
      } catch(e) { showStatus('‚ùå ' + e.message, 'danger'); }
    }

    function showStatus(msg, type) {
      var el = document.getElementById('statusMsg');
      el.className = 'alert alert-' + type + ' py-2 mb-3';
      el.textContent = msg;
      el.style.display = 'block';
    }
    function hideStatus() {
      document.getElementById('statusMsg').style.display = 'none';
    }
    function escHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // Start
    init();
  </script>
</body>
</html>
