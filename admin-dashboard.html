<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - HookUpZA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    * { box-sizing: border-box; }
    html, body { background: #0a0a0a; color: #eee; margin: 0; padding: 0; font-family: sans-serif; }
    nav { background: #000; border-bottom: 2px solid #dc3545; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .nav-btns a { border: 1px solid #ffc107; color: #ffc107; padding: 5px 12px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; margin-left: 8px; }
    .nav-btns a.light { border-color: #aaa; color: #aaa; }
    #statusBar { padding: 10px 20px; display: none; font-weight: 600; text-align: center; }
    .page { padding: 20px; }

    /* Stats */
    .stats-row { display: flex; gap: 14px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-box { flex: 1; min-width: 120px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; padding: 18px; text-align: center; }
    .stat-box h2 { margin: 0 0 4px; font-size: 2rem; color: #fff; }
    .stat-box p { margin: 0; color: rgba(255,255,255,0.8); font-size: 0.85rem; }

    /* Action buttons */
    .actions { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
    .btn-approve-bulk { background: #198754; color: #fff; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; flex: 1; }
    .btn-expire-bulk  { background: #ffc107; color: #000; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; flex: 1; }

    /* Filter tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .tab { border: 1px solid #555; color: #aaa; background: transparent; padding: 5px 14px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
    .tab.active { background: #dc3545; border-color: #dc3545; color: #fff; }

    /* Ad rows */
    .ad-row { background: #1a1a1a; border: 1px solid #2d2d2d; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
    .ad-row:hover { border-color: #dc3545; }
    .ad-row-title { font-size: 1rem; font-weight: 700; color: #fff; margin: 0 0 6px; }
    .ad-row-desc  { color: #777; font-size: 0.82rem; margin: 0 0 10px; }
    .ad-row-badges { margin-bottom: 10px; }
    .badge { display: inline-block; padding: 3px 9px; border-radius: 12px; font-size: 0.72rem; font-weight: 600; margin-right: 4px; }
    .bg-success { background: #198754; color: #fff; }
    .bg-warning { background: #ffc107; color: #000; }
    .bg-secondary { background: #6c757d; color: #fff; }
    .bg-danger { background: #dc3545; color: #fff; }
    .bg-dark { background: #333; color: #fff; }
    .bg-info { background: #0dcaf0; color: #000; }
    .ad-row-meta { color: #666; font-size: 0.8rem; margin-bottom: 12px; display: flex; gap: 14px; flex-wrap: wrap; }
    .ad-row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-sm-approve { background: #198754; color: #fff; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.82rem; }
    .btn-sm-reject  { background: #dc3545; color: #fff; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.82rem; }
    .btn-sm-expire  { background: #ffc107; color: #000; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.82rem; }
    .btn-sm-reactivate { background: transparent; border: 1px solid #198754; color: #198754; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.82rem; }
    .btn-sm-delete  { background: transparent; border: 1px solid #dc3545; color: #dc3545; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.82rem; }
    .empty { text-align: center; padding: 50px; color: #555; }
  </style>
</head>
<body>

  <nav>
    <span style="font-weight:700;font-size:1.1rem;"><i class="bi bi-shield-lock-fill" style="color:#dc3545"></i> Admin Dashboard</span>
    <div class="nav-btns">
      <a href="admin-users.html"><i class="bi bi-people"></i> Users</a>
      <a href="index.html" class="light"><i class="bi bi-house"></i> Site</a>
    </div>
  </nav>

  <div id="statusBar"></div>

  <div class="page">

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-box"><h2 id="sTotalAds">‚Äî</h2><p>Total Ads</p></div>
      <div class="stat-box"><h2 id="sPending">‚Äî</h2><p>Pending</p></div>
      <div class="stat-box"><h2 id="sActive">‚Äî</h2><p>Active</p></div>
      <div class="stat-box"><h2 id="sUsers">‚Äî</h2><p>Users</p></div>
    </div>

    <!-- Bulk actions -->
    <div class="actions">
      <button class="btn-approve-bulk" onclick="bulkAutoApprove()"><i class="bi bi-check-all"></i> Auto-Approve (24h+ ads)</button>
      <button class="btn-expire-bulk"  onclick="bulkExpire()"><i class="bi bi-clock-history"></i> Expire Old Ads</button>
    </div>

    <!-- Filter tabs -->
    <div class="tabs">
      <button class="tab active" onclick="setFilter('all',this)">All</button>
      <button class="tab" onclick="setFilter('pending',this)">Pending</button>
      <button class="tab" onclick="setFilter('active',this)">Active</button>
      <button class="tab" onclick="setFilter('expired',this)">Expired</button>
      <button class="tab" onclick="setFilter('rejected',this)">Rejected</button>
    </div>

    <!-- Ads list -->
    <div id="adsList"><p style="color:#555;text-align:center;padding:40px;">Loading ads...</p></div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/hookupza.js"></script>
  <script>
    var ALL_ADS = [];
    var currentFilter = 'all';

    function showMsg(msg, type) {
      var colors = { success:'#0f5132', danger:'#5c1a1a', warning:'#6b4f00', info:'#0a3d5c' };
      var el = document.getElementById('statusBar');
      el.style.background = colors[type] || '#333';
      el.style.color = '#fff';
      el.style.display = 'block';
      el.textContent = msg;
      if (type === 'success') setTimeout(function(){ el.style.display='none'; }, 3000);
    }

    function api(path, opts) {
      return fetch(API_BASE + path, Object.assign({ credentials:'include' }, opts||{}));
    }

    async function init() {
      console.log('init, API_BASE=', JSON.stringify(API_BASE));
      try {
        var r = await api('/api/admin/check_role');
        var d = await r.json();
        if (!d.is_admin) { alert('Admin access required'); window.location.href='index.html'; return; }
        console.log('Admin verified:', d.username);
      } catch(e) { alert('Cannot verify admin: '+e.message); window.location.href='index.html'; return; }

      loadStats();
      loadAds();
      setInterval(loadStats, 30000);
    }

    async function loadStats() {
      try {
        var r = await api('/api/admin/stats');
        var s = await r.json();
        document.getElementById('sTotalAds').textContent = s.total_ads   ?? '?';
        document.getElementById('sPending').textContent  = s.pending_ads ?? '?';
        document.getElementById('sActive').textContent   = s.active_ads  ?? '?';
        document.getElementById('sUsers').textContent    = s.total_users  ?? '?';
      } catch(e) {}
    }

    async function loadAds() {
      document.getElementById('adsList').innerHTML = '<p style="color:#555;text-align:center;padding:40px;">Loading...</p>';
      try {
        var r = await api('/api/admin/all_ads');
        console.log('all_ads response:', r.status);
        var data = await r.json();
        ALL_ADS = data.ads || [];
        console.log('Got', ALL_ADS.length, 'ads');
        renderAds();
      } catch(e) {
        document.getElementById('adsList').innerHTML = '<p style="color:#dc3545;padding:20px;">Error loading ads: '+e.message+'</p>';
        showMsg('Error: '+e.message, 'danger');
      }
    }

    function setFilter(f, btn) {
      currentFilter = f;
      document.querySelectorAll('.tab').forEach(function(b){ b.classList.remove('active'); });
      if (btn) btn.classList.add('active');
      renderAds();
    }

    function renderAds() {
      var ads = currentFilter === 'all' ? ALL_ADS : ALL_ADS.filter(function(a){ return a.status === currentFilter; });
      console.log('Rendering', ads.length, 'ads for filter:', currentFilter);
      var el = document.getElementById('adsList');
      if (!ads.length) {
        el.innerHTML = '<div class="empty"><i class="bi bi-inbox" style="font-size:3rem;display:block;margin-bottom:12px;"></i>No '+currentFilter+' ads</div>';
        return;
      }
      var html = '';
      for (var i = 0; i < ads.length; i++) html += buildRow(ads[i]);
      el.innerHTML = html;
      console.log('Done. Container height:', el.offsetHeight, 'innerHTML length:', el.innerHTML.length);
    }

    function buildRow(ad) {
      var daysLeft = ad.expires_at ? Math.floor((new Date(ad.expires_at) - Date.now()) / 86400000) : -1;
      var sc = { active:'bg-success', pending:'bg-warning', expired:'bg-secondary', rejected:'bg-danger' }[ad.status] || 'bg-secondary';
      var desc = String(ad.description || '').substring(0, 100);

      var badges = '<span class="badge ' + sc + '">' + String(ad.status||'').toUpperCase() + '</span> ' +
                   '<span class="badge bg-secondary">' + esc(ad.category||'') + '</span> ' +
                   (ad.account_type==='vendor' ? '<span class="badge bg-warning">PREMIUM</span> ' : '<span class="badge bg-info">FREE</span> ') +
                   (daysLeft>=0 ? '<span class="badge bg-dark">'+daysLeft+'d left</span>' : '<span class="badge bg-danger">EXPIRED</span>');

      var meta = '<span><i class="bi bi-person"></i> ' + esc(ad.username||'?') + '</span>' +
                 '<span><i class="bi bi-geo-alt"></i> ' + esc(ad.location||'-') + '</span>' +
                 '<span><i class="bi bi-calendar"></i> ' + (ad.created_at ? new Date(ad.created_at).toLocaleDateString() : '-') + '</span>' +
                 '<span style="color:#888;">ID #' + ad.id + '</span>';

      var btns = '';
      if (ad.status==='pending') {
        btns += '<button class="btn-sm-approve" onclick="approve('+ad.id+')"><i class="bi bi-check"></i> Approve</button>';
        btns += '<button class="btn-sm-reject"  onclick="reject('+ad.id+')"><i class="bi bi-x"></i> Reject</button>';
      }
      if (ad.status==='active') {
        btns += '<button class="btn-sm-expire" onclick="expire('+ad.id+')"><i class="bi bi-clock"></i> Expire</button>';
      }
      if (ad.status==='rejected'||ad.status==='expired') {
        btns += '<button class="btn-sm-reactivate" onclick="approve('+ad.id+')"><i class="bi bi-arrow-counterclockwise"></i> Reactivate</button>';
      }
      btns += '<button class="btn-sm-delete" onclick="del('+ad.id+')"><i class="bi bi-trash"></i> Delete</button>';

      return '<div class="ad-row">' +
        '<div class="ad-row-title">' + esc(ad.title||'Untitled') + '</div>' +
        '<div class="ad-row-desc">' + esc(desc) + (desc.length>=100?'‚Ä¶':'') + '</div>' +
        '<div class="ad-row-badges">' + badges + '</div>' +
        '<div class="ad-row-meta">' + meta + '</div>' +
        '<div class="ad-row-actions">' + btns + '</div>' +
      '</div>';
    }

    async function approve(id){ var r=await api('/api/admin/approve_ad/'+id,{method:'POST'}); if(r.ok){showMsg('‚úÖ Approved','success');loadAds();loadStats();}else showMsg('‚ùå Failed','danger'); }
    async function reject(id) { var r=await api('/api/admin/reject_ad/'+id,{method:'POST'});  if(r.ok){showMsg('Rejected','warning');loadAds();loadStats();} }
    async function expire(id) { var r=await api('/api/admin/reject_ad/'+id,{method:'POST'});  if(r.ok){showMsg('Expired','warning');loadAds();loadStats();} }
    async function del(id)    {
      if(!confirm('Permanently delete this ad?')) return;
      showMsg('Deleting...','info');
      var r=await api('/api/admin/delete_ad/'+id,{method:'DELETE'});
      if(r.ok){showMsg('‚úÖ Deleted','success');loadAds();loadStats();}else showMsg('‚ùå Failed','danger');
    }
    async function bulkAutoApprove() { showMsg('Running...','info'); var r=await api('/api/admin/auto_approve',{method:'POST'}); var d=await r.json().catch(function(){return{};}); showMsg('‚úÖ '+(d.count||0)+' approved','success'); loadAds(); loadStats(); }
    async function bulkExpire()      { showMsg('Running...','info'); var r=await api('/api/admin/expire_old_ads',{method:'POST'}); var d=await r.json().catch(function(){return{};}); showMsg('üïí '+(d.count||0)+' expired','warning'); loadAds(); loadStats(); }

    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    init();
  </script>
</body>
</html>
