<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - HookUpZA Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background: #0a0a0a; }
    .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="text-light">

  <nav class="navbar navbar-dark bg-black border-bottom border-danger">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">
        <i class="bi bi-people-fill text-danger"></i> User Management
      </span>
      <div class="d-flex gap-2">
        <a href="admin-dashboard.html" class="btn btn-outline-warning btn-sm">
          <i class="bi bi-speedometer"></i> Dashboard
        </a>
        <a href="index.html" class="btn btn-outline-light btn-sm">
          <i class="bi bi-house"></i> Back to Site
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-4">

    <!-- Create New Admin -->
    <div class="card bg-dark border-warning mb-4 shadow">
      <div class="card-header admin-header text-white border-0">
        <h5 class="mb-0"><i class="bi bi-shield-plus"></i> Create New Admin</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small">Username</label>
            <input type="text" class="form-control bg-secondary text-light border-0"
                   id="newAdminUsername" placeholder="admin_username">
          </div>
          <div class="col-md-3">
            <label class="form-label small">Password</label>
            <input type="password" class="form-control bg-secondary text-light border-0"
                   id="newAdminPassword" placeholder="Min 8 characters">
          </div>
          <div class="col-md-3">
            <label class="form-label small">Email (optional)</label>
            <input type="email" class="form-control bg-secondary text-light border-0"
                   id="newAdminEmail" placeholder="admin@email.com">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-warning w-100 fw-bold" onclick="createAdmin()">
              <i class="bi bi-plus-circle"></i> Create Admin
            </button>
          </div>
        </div>
        <div id="createMsg" class="mt-2" style="display:none"></div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="card bg-dark border-secondary shadow">
      <div class="card-header bg-transparent border-secondary">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-people"></i> All Users</h5>
          <button class="btn btn-sm btn-outline-light" onclick="loadUsers()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover mb-0">
            <thead class="table-secondary">
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Age</th>
                <th>Type</th>
                <th>Role</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="8" class="text-center py-5">
                  <div class="spinner-border text-danger mb-3"></div>
                  <p class="text-muted">Loading users...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/hookupza.js"></script>
  <script>

    // Check admin on load
    async function checkAdmin() {
      try {
        var res = await fetch(API_BASE + '/api/admin/check_role', { credentials: 'include' });
        var data = await res.json();
        if (!data.is_admin) {
          alert('❌ Admin access required. Please login as admin.');
          window.location.href = 'index.html';
        } else {
          console.log('✅ Admin confirmed:', data.username);
        }
      } catch(e) {
        alert('❌ Failed to verify admin status');
        window.location.href = 'index.html';
      }
    }

    // Load all users
    async function loadUsers() {
      try {
        var res = await fetch(API_BASE + '/api/admin/users', { credentials: 'include' });
        var data = await res.json();
        var tbody = document.getElementById('usersTableBody');

        if (!data.users || data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No users found</td></tr>';
          return;
        }

        tbody.innerHTML = data.users.map(function(user) {
          return '<tr>' +
            '<td>' + user.id + '</td>' +
            '<td><strong>' + user.username + '</strong>' +
              (user.verified ? ' <i class="bi bi-patch-check-fill text-success"></i>' : '') +
            '</td>' +
            '<td class="small">' + (user.email || '<span class="text-muted">-</span>') + '</td>' +
            '<td class="small">' + (user.age || '-') + '</td>' +
            '<td><span class="badge ' + (user.account_type==='vendor' ? 'bg-warning text-dark' : 'bg-info') + '">' + (user.account_type||'free') + '</span></td>' +
            '<td><span class="badge ' + (user.role==='admin' ? 'bg-danger' : 'bg-secondary') + '">' + (user.role||'user') + '</span></td>' +
            '<td class="small">' + formatDate(user.created_at) + '</td>' +
            '<td>' +
              '<div class="btn-group btn-group-sm">' +
                (user.role !== 'admin'
                  ? '<button class="btn btn-outline-warning" onclick="makeAdmin(' + user.id + ',\'' + user.username + '\')" title="Make admin"><i class="bi bi-shield-fill-plus"></i></button>'
                  : '<button class="btn btn-outline-secondary" onclick="removeAdmin(' + user.id + ',\'' + user.username + '\')" title="Remove admin"><i class="bi bi-shield-fill-x"></i></button>') +
                '<button class="btn btn-outline-danger" onclick="deleteUser(' + user.id + ',\'' + user.username + '\')" title="Delete"><i class="bi bi-trash"></i></button>' +
              '</div>' +
            '</td>' +
          '</tr>';
        }).join('');

        console.log('✅ Loaded', data.users.length, 'users');
      } catch(e) {
        console.error('Failed to load users:', e);
        document.getElementById('usersTableBody').innerHTML =
          '<tr><td colspan="8" class="text-center text-danger py-4">Failed to load users: ' + e.message + '</td></tr>';
      }
    }

    // Create admin
    async function createAdmin() {
      var username = document.getElementById('newAdminUsername').value.trim();
      var password = document.getElementById('newAdminPassword').value;
      var email    = document.getElementById('newAdminEmail').value.trim();
      var msg = document.getElementById('createMsg');

      if (!username || !password) { showMsg('Please enter username and password', 'danger'); return; }
      if (password.length < 8)    { showMsg('Password must be at least 8 characters', 'danger'); return; }

      try {
        var res = await fetch(API_BASE + '/api/admin/create_admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password, email })
        });
        var data = await res.json();
        if (res.ok) {
          showMsg('✅ Admin "' + username + '" created successfully!', 'success');
          document.getElementById('newAdminUsername').value = '';
          document.getElementById('newAdminPassword').value = '';
          document.getElementById('newAdminEmail').value = '';
          loadUsers();
        } else {
          showMsg('❌ ' + (data.error || 'Failed to create admin'), 'danger');
        }
      } catch(e) {
        showMsg('❌ Network error: ' + e.message, 'danger');
      }
    }

    function showMsg(text, type) {
      var el = document.getElementById('createMsg');
      el.className = 'alert alert-' + type + ' py-2';
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(function(){ el.style.display = 'none'; }, 4000);
    }

    async function makeAdmin(userId, username) {
      if (!confirm('Grant admin access to "' + username + '"?')) return;
      var res = await fetch(API_BASE + '/api/admin/update_role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ user_id: userId, role: 'admin' })
      });
      if (res.ok) { alert('✅ ' + username + ' is now an admin'); loadUsers(); }
      else alert('❌ Failed to update role');
    }

    async function removeAdmin(userId, username) {
      if (!confirm('Remove admin access from "' + username + '"?')) return;
      var res = await fetch(API_BASE + '/api/admin/update_role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ user_id: userId, role: 'user' })
      });
      if (res.ok) { alert('✅ Admin removed from ' + username); loadUsers(); }
      else alert('❌ Failed to update role');
    }

    async function deleteUser(userId, username) {
      if (!confirm('⚠️ Delete user "' + username + '"?\nThis will delete the account and all their ads.\nCannot be undone.')) return;
      if (!confirm('Are you ABSOLUTELY SURE you want to delete "' + username + '"?')) return;
      var res = await fetch(API_BASE + '/api/admin/delete_user', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ user_id: userId })
      });
      if (res.ok) { alert('✅ User "' + username + '" deleted'); loadUsers(); }
      else alert('❌ Failed to delete user');
    }

    function formatDate(d) {
      if (!d) return '-';
      var dt = new Date(d);
      return dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }

    // Init
    checkAdmin();
    loadUsers();
  </script>
</body>
</html>
